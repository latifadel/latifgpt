<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LatifGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --bg-chat: #020617;
      --border-subtle: #1f2937;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #22c55e;
      --accent-soft: #14532d;
      --user-bubble: #2563eb;
      --bot-bubble: #111827;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 35%, #020617 100%);
      color: var(--text);
      height: 100vh;
      display: flex;
    }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
    }

    .sidebar {
      border-right: 1px solid var(--border-subtle);
      background: #020617;
      display: flex;
      flex-direction: column;
      padding: 0.75rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #4ade80, #22c55e 30%, #15803d 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #022c22;
      font-size: 0.9rem;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-text strong {
      font-size: 0.95rem;
    }

    .logo-text span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .sidebar button {
      border-radius: 999px;
      border: 1px solid #334155;
      background: #020617;
      color: var(--text);
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      cursor: pointer;
      margin-bottom: 0.25rem;
    }

    .sidebar button span {
      font-size: 0.9rem;
    }

    .sidebar button:hover {
      background: #0b1120;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 0.25rem 0.5rem;
      border-top: 1px solid #111827;
    }

    .sidebar-footer strong {
      color: #a5b4fc;
    }

    .main {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .topbar {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, #020617, #020617 40%, #020617 100%);
    }

    .topbar-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .topbar-title strong {
      font-size: 0.95rem;
    }

    .topbar-title span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    #status {
      font-size: 0.75rem;
      color: #a5b4fc;
    }

    .chat-wrapper {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }

    .empty-state {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 0 1rem;
    }

    .msg-row {
      display: flex;
      gap: 0.6rem;
      margin-bottom: 0.85rem;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .avatar.user {
      background: #1d4ed8;
      color: #e5e7eb;
    }

    .avatar.bot {
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .bubble-wrap {
      max-width: min(75%, 720px);
    }

    .name-row {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .bubble {
      padding: 0.55rem 0.8rem;
      border-radius: 0.85rem;
      line-height: 1.4;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user {
      background: var(--user-bubble);
      color: #e5e7eb;
      border-bottom-right-radius: 0.2rem;
    }

    .bubble.bot {
      background: var(--bot-bubble);
      border: 1px solid var(--border-subtle);
      border-bottom-left-radius: 0.2rem;
    }

    .typing {
      display: inline-block;
    }

    .typing span {
      display: inline-block;
      width: 4px;
      height: 4px;
      margin: 0 1px;
      border-radius: 999px;
      background: #9ca3af;
      animation: blink 1s infinite ease-in-out;
    }

    .typing span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-1px); }
    }

    .input-area {
      border-top: 1px solid var(--border-subtle);
      padding: 0.75rem 1rem 1rem;
      background: #020617d9;
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .input-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    #prompt {
      flex: 1;
      resize: none;
      border-radius: 0.75rem;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text);
      padding: 0.55rem 0.75rem;
      min-height: 2.4rem;
      max-height: 7rem;
      font-family: inherit;
      font-size: 0.9rem;
    }

    #prompt:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px #15803d80;
    }

    #send {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1rem;
      cursor: pointer;
      background: var(--accent);
      color: #022c22;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
    }

    #send:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }

    .hint span {
      white-space: nowrap;
    }

    .hint a {
      color: #a5b4fc;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">L</div>
        <div class="logo-text">
          <strong>LatifGPT</strong>
          <span>Made by Latif</span>
        </div>
      </div>
      <button id="new-chat-btn">
        <span>＋</span> <span>New chat</span>
      </button>
      <div class="sidebar-footer">
        Runs fully in your browser.<br />
        No API keys required.
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar-title">
          <strong>LatifGPT</strong>
          <span>TinyLlama model in your browser</span>
        </div>
        <div id="status">Loading model… first time may take a bit ⏳</div>
      </header>

      <div class="chat-wrapper">
        <div id="chat">
          <div class="empty-state" id="empty-state">
            <div>
              <h2 style="margin:0 0 0.4rem;font-size:1.1rem;">Welcome to LatifGPT</h2>
              <p style="margin:0;font-size:0.85rem;">
                Ask a question below. The first time you use it, the AI model is downloaded into
                your browser and then reused from cache.
              </p>
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="input-row">
            <textarea id="prompt" placeholder="Ask LatifGPT anything…"></textarea>
            <button id="send" disabled>Send ➤</button>
          </div>
          <div class="hint">
            <span>Enter to send · Shift+Enter for new line</span>
            <span>Tip: keep questions specific for better answers</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    const SELECTED_MODEL = "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC-1k";

    const chatEl = document.getElementById("chat");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("send");
    const statusEl = document.getElementById("status");
    const emptyStateEl = document.getElementById("empty-state");
    const newChatBtn = document.getElementById("new-chat-btn");

    let engine = null;
    let engineReady = false;

    const messages = [
      {
        role: "system",
        content: "You are LatifGPT, a friendly and concise AI assistant created by Latif."
      }
    ];

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function clearChatUI() {
      chatEl.innerHTML = "";
      if (emptyStateEl) {
        const clone = emptyStateEl.cloneNode(true);
        clone.id = "empty-state";
        chatEl.appendChild(clone);
      }
    }

    function startNewChat() {
      messages.splice(1); // keep system message
      clearChatUI();
    }

    newChatBtn.addEventListener("click", () => {
      startNewChat();
    });

    function removeEmptyState() {
      const es = document.getElementById("empty-state");
      if (es && es.parentNode) {
        es.parentNode.removeChild(es);
      }
    }

    function addMessage(role, content, options = {}) {
      removeEmptyState();

      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "bot");

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (role === "user" ? "user" : "bot");
      avatar.textContent = role === "user" ? "You" : "L";

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";

      const nameRow = document.createElement("div");
      nameRow.className = "name-row";
      nameRow.textContent = role === "user" ? "You" : "LatifGPT";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "user" : "bot");
      bubble.textContent = content || "";

      wrap.appendChild(nameRow);
      wrap.appendChild(bubble);

      if (role === "user") {
        row.appendChild(wrap);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(wrap);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;

      if (options.typingIndicator) {
        bubble.textContent = "";
        const typing = document.createElement("div");
        typing.className = "typing";
        typing.innerHTML = "<span></span><span></span><span></span>";
        bubble.appendChild(typing);
        return { row, bubble, typing };
      }

      return { row, bubble };
    }

    async function initEngine() {
      try {
        setStatus("Loading TinyLlama model into your browser…");
        engine = await CreateMLCEngine(SELECTED_MODEL, {
          initProgressCallback(info) {
            if (info && info.text) {
              setStatus(info.text);
            }
          }
        });
        engineReady = true;
        setStatus("Ready ✅");
        sendBtn.disabled = false;
      } catch (err) {
        console.error(err);
        setStatus("Error loading model. Your browser may not support WebGPU.");
      }
    }

    initEngine();

    async function sendMessage() {
      const content = promptEl.value.trim();
      if (!content) return;

      if (!engineReady) {
        alert("Model is still loading. Please wait a bit, then try again.");
        return;
      }

      sendBtn.disabled = true;
      promptEl.value = "";
      promptEl.style.height = "auto";

      messages.push({ role: "user", content });
      addMessage("user", content);

      setStatus("LatifGPT is thinking…");
      const { bubble } = addMessage("assistant", "", { typingIndicator: true });

      let replyText = "";

      try {
        const stream = await engine.chat.completions.create({
          messages,
          temperature: 0.7,
          stream: true
        });

        for await (const chunk of stream) {
          const delta = chunk.choices?.[0]?.delta?.content || "";
          if (!delta) continue;
          replyText += delta;
          bubble.textContent = replyText;
          chatEl.scrollTop = chatEl.scrollHeight;
        }

        if (!replyText) {
          replyText = "I couldn't generate a reply this time. Try asking again.";
          bubble.textContent = replyText;
        }

        messages.push({ role: "assistant", content: replyText });
        setStatus("Ready ✅");
      } catch (err) {
        console.error(err);
        bubble.textContent = "Error running the model in your browser.";
        setStatus("Error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    promptEl.addEventListener("input", () => {
      promptEl.style.height = "auto";
      promptEl.style.height = Math.min(promptEl.scrollHeight, 140) + "px";
    });
  </script>
</body>
</html>
