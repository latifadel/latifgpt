<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LatifGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --border-subtle: #1f2937;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #22c55e;
      --accent-soft: #14532d;
      --danger: #ef4444;
      --user-bubble: #2563eb;
      --bot-bubble: #111827;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    /* Shell centers content on big screens, fills on iPhone */
    .shell {
      width: 100%;
      max-width: 900px;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Header */
    .topbar {
      padding: 0.75rem 1rem;
      padding-top: calc(0.5rem + env(safe-area-inset-top));
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: linear-gradient(to right, #020617, #020617 40%, #020617 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #4ade80, #22c55e 30%, #15803d 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #022c22;
      font-size: 0.95rem;
      flex-shrink: 0;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-text strong {
      font-size: 1rem;
    }

    .logo-text span {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .status-wrap {
      text-align: right;
      font-size: 0.72rem;
      color: #a5b4fc;
      max-width: 50%;
    }

    @media (max-width: 480px) {
      .topbar {
        padding-inline: 0.75rem;
      }
      .status-wrap {
        max-width: 55%;
      }
    }

    /* Chat area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* important for iOS scroll */
    }

    #chat {
      flex: 1;
      padding: 0.75rem 1rem;
      padding-bottom: 0.75rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    @media (max-width: 480px) {
      #chat {
        padding-inline: 0.75rem;
      }
    }

    .empty-state {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 0 1rem;
    }

    .empty-state h2 {
      margin: 0 0 0.4rem;
      font-size: 1.05rem;
    }

    .empty-state p {
      margin: 0;
      font-size: 0.85rem;
    }

    .msg-row {
      display: flex;
      gap: 0.6rem;
      margin-bottom: 0.85rem;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .avatar.user {
      background: #1d4ed8;
      color: #e5e7eb;
    }

    .avatar.bot {
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .bubble-wrap {
      max-width: 85%;
    }

    @media (min-width: 768px) {
      .bubble-wrap {
        max-width: 75%;
      }
    }

    .name-row {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .bubble {
      padding: 0.6rem 0.85rem;
      border-radius: 0.9rem;
      line-height: 1.45;
      font-size: 0.92rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user {
      background: var(--user-bubble);
      color: #e5e7eb;
      border-bottom-right-radius: 0.25rem;
    }

    .bubble.bot {
      background: var(--bot-bubble);
      border: 1px solid var(--border-subtle);
      border-bottom-left-radius: 0.25rem;
    }

    .typing {
      display: inline-block;
    }

    .typing span {
      display: inline-block;
      width: 4px;
      height: 4px;
      margin: 0 1px;
      border-radius: 999px;
      background: #9ca3af;
      animation: blink 1s infinite ease-in-out;
    }

    .typing span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-1px); }
    }

    /* Input area - sticky bottom, big tap targets */
    .input-area {
      border-top: 1px solid var(--border-subtle);
      padding: 0.6rem 1rem 0.9rem;
      padding-bottom: calc(0.9rem + env(safe-area-inset-bottom));
      background: #020617f0;
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    @media (max-width: 480px) {
      .input-area {
        padding-inline: 0.75rem;
      }
    }

    .input-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    #prompt {
      flex: 1;
      resize: none;
      border-radius: 0.9rem;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text);
      padding: 0.7rem 0.8rem;
      min-height: 2.6rem;
      max-height: 7rem;
      font-family: inherit;
      font-size: 0.92rem;
      line-height: 1.4;
    }

    #prompt:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px #15803d80;
    }

    #send {
      border: none;
      border-radius: 999px;
      padding: 0.7rem 1.15rem;
      cursor: pointer;
      background: var(--accent);
      color: #022c22;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      white-space: nowrap;
      flex-shrink: 0;
      min-width: 84px;
      min-height: 44px; /* good for thumb tap */
    }

    #send.generating {
      background: var(--danger);
      color: #fee2e2;
    }

    #send:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .hint {
      font-size: 0.72rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .hint span {
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      .hint {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .pill-row {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.15rem;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-muted);
      font-size: 0.72rem;
      padding: 0.25rem 0.6rem;
      cursor: pointer;
    }

    .pill-btn:hover {
      background: #0b1120;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <div class="logo-icon">L</div>
          <div class="logo-text">
            <strong>LatifGPT</strong>
            <span>Runs locally in your browser</span>
          </div>
        </div>
        <div class="status-wrap" id="status">Loading model… first time may take a bit ⏳</div>
      </header>

      <main class="main">
        <div id="chat">
          <div class="empty-state" id="empty-state">
            <div>
              <h2>Welcome to LatifGPT</h2>
              <p>
                Ask a question below. On first use, the AI model downloads to your device, then runs
                locally and is reused from cache.
              </p>
            </div>
          </div>
        </div>

        <section class="input-area">
          <div class="input-row">
            <textarea id="prompt" placeholder="Ask LatifGPT anything…"></textarea>
            <button id="send" disabled>Send ➤</button>
          </div>
          <div class="hint">
            <span>Enter to send · Shift+Enter for new line</span>
            <span>Button becomes “Stop” while the AI is replying</span>
          </div>
          <div class="pill-row">
            <button class="pill-btn" data-sample="Explain recursion like I’m 10.">Recursion simple</button>
            <button class="pill-btn" data-sample="Help me plan a productive study routine for computer science.">Study routine</button>
            <button class="pill-btn" data-sample="Summarize the difference between frontend and backend development.">Frontend vs backend</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    // Phi-3 Mini: better quality than very tiny models, still OK for browser
    const MODEL_ID = "Phi-3-mini-4k-instruct-q4f16_1-MLC";

    const chatEl = document.getElementById("chat");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("send");
    const statusEl = document.getElementById("status");
    const emptyStateEl = document.getElementById("empty-state");
    const pillButtons = document.querySelectorAll(".pill-btn");

    let engine = null;
    let engineReady = false;

    let isGenerating = false;
    let stopRequested = false;

    const messages = [
      {
        role: "system",
        content:
          "You are LatifGPT, a friendly, concise AI assistant created by Latif. " +
          "Explain things clearly and avoid making up facts if you are not sure."
      }
    ];

    function setStatus(text) {
      if (statusEl) statusEl.textContent = text;
    }

    function removeEmptyState() {
      const es = document.getElementById("empty-state");
      if (es && es.parentNode) {
        es.parentNode.removeChild(es);
      }
    }

    function clearChatUI() {
      chatEl.innerHTML = "";
      if (emptyStateEl) {
        const clone = emptyStateEl.cloneNode(true);
        clone.id = "empty-state";
        chatEl.appendChild(clone);
      }
    }

    function addMessage(role, content, options = {}) {
      removeEmptyState();

      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "bot");

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (role === "user" ? "user" : "bot");
      avatar.textContent = role === "user" ? "You" : "L";

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";

      const nameRow = document.createElement("div");
      nameRow.className = "name-row";
      nameRow.textContent = role === "user" ? "You" : "LatifGPT";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "user" : "bot");
      bubble.textContent = content || "";

      wrap.appendChild(nameRow);
      wrap.appendChild(bubble);

      if (role === "user") {
        row.appendChild(wrap);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(wrap);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;

      if (options.typingIndicator) {
        bubble.textContent = "";
        const typing = document.createElement("div");
        typing.className = "typing";
        typing.innerHTML = "<span></span><span></span><span></span>";
        bubble.appendChild(typing);
        return { row, bubble, typing };
      }

      return { row, bubble };
    }

    async function initEngine() {
      try {
        setStatus("Loading Phi-3 Mini into your device…");
        engine = await CreateMLCEngine(MODEL_ID, {
          initProgressCallback(info) {
            if (info && info.text) {
              setStatus(info.text);
            }
          }
        });
        engineReady = true;
        setStatus("Model ready ✅");
        sendBtn.disabled = false;
      } catch (err) {
        console.error(err);
        setStatus("Error loading model. Your browser may not support WebGPU.");
      }
    }

    initEngine();

    function setGeneratingState(on) {
      isGenerating = on;
      if (on) {
        sendBtn.classList.add("generating");
        sendBtn.textContent = "Stop ■";
      } else {
        sendBtn.classList.remove("generating");
        sendBtn.textContent = "Send ➤";
      }
    }

    async function handleSendOrStop() {
      if (isGenerating) {
        // Stop streaming
        stopRequested = true;
        setStatus("Stopping…");
        return;
      }
      await sendMessage();
    }

    async function sendMessage() {
      const content = promptEl.value.trim();
      if (!content) return;

      if (!engineReady) {
        alert("Model is still loading. Please wait a bit and try again.");
        return;
      }

      stopRequested = false;
      setGeneratingState(true);
      sendBtn.disabled = false; // keep enabled so user can tap Stop

      const userText = content;
      promptEl.value = "";
      promptEl.style.height = "auto";

      messages.push({ role: "user", content: userText });
      addMessage("user", userText);

      setStatus("LatifGPT is thinking…");
      const { bubble } = addMessage("assistant", "", { typingIndicator: true });

      let replyText = "";

      try {
        const stream = await engine.chat.completions.create({
          messages,
          temperature: 0.7,
          stream: true
        });

        for await (const chunk of stream) {
          if (stopRequested) {
            break;
          }
          const delta = chunk.choices?.[0]?.delta?.content || "";
          if (!delta) continue;
          replyText += delta;
          bubble.textContent = replyText;
          chatEl.scrollTop = chatEl.scrollHeight;
        }

        if (!replyText) {
          replyText = stopRequested
            ? "Stopped."
            : "I couldn't generate a reply this time. Try again.";
          bubble.textContent = replyText;
        }

        messages.push({ role: "assistant", content: replyText });
        setStatus(stopRequested ? "Generation stopped" : "Ready ✅");
      } catch (err) {
        console.error(err);
        bubble.textContent = "Error running the model in your browser.";
        setStatus("Error");
      } finally {
        setGeneratingState(false);
        sendBtn.disabled = false;
        stopRequested = false;
      }
    }

    sendBtn.addEventListener("click", handleSendOrStop);

    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!isGenerating) {
          handleSendOrStop();
        }
      }
    });

    promptEl.addEventListener("input", () => {
      promptEl.style.height = "auto";
      promptEl.style.height = Math.min(promptEl.scrollHeight, 140) + "px";
    });

    pillButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const text = btn.getAttribute("data-sample");
        if (!text) return;
        promptEl.value = text;
        promptEl.focus();
        promptEl.dispatchEvent(new Event("input"));
      });
    });
  </script>
</body>
</html>
